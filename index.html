<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Finance Tracker Calendar</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="js/check_session.js"></script>
  </head>
  <body>
    <h1>Finance Tracker</h1>

    <div class="controls">
      <select id="monthSelect"></select>
      <select id="yearSelect"></select>
    </div>

    <div class="calendar-wrapper">
      <div class="calendar-header">
        <div>Sun</div>
        <div>Mon</div>
        <div>Tue</div>
        <div>Wed</div>
        <div>Thu</div>
        <div>Fri</div>
        <div>Sat</div>
      </div>
      <div id="calendar" class="calendar"></div>
    </div>

    <!-- Modal -->
    <div id="entryModal">
      <h2 id="selectedDateTitle"></h2>

      <label for="type"><strong>Type:</strong></label>
      <select id="type">
        <option value="in">Money In</option>
        <option value="out">Money Out</option>
      </select><br /><br />

      <input type="text" id="desc" placeholder="Description" /><br /><br />
      <input type="number" id="amount" placeholder="Amount" /><br /><br />

      <button onclick="addEntry()">Add Entry</button>
      <button onclick="closeModal()">Close</button>

      <ul id="entryList"></ul>
    </div>

    <div id="modalOverlay" onclick="closeModal()"></div>
    <div id="toast"></div>

    <script>
      const calendarEl = document.getElementById("calendar");
      const selectedDateTitle = document.getElementById("selectedDateTitle");
      const entryList = document.getElementById("entryList");
      const monthSelect = document.getElementById("monthSelect");
      const yearSelect = document.getElementById("yearSelect");

      const monthNames = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];

      let selectedDate = "";
      const financeData = JSON.parse(localStorage.getItem("financeData") || "{}");

      const now = new Date();
      let selectedMonth = now.getMonth();
      let selectedYear = now.getFullYear();

      for (let i = 0; i < 12; i++) {
        monthSelect.innerHTML += `<option value="${i}">${monthNames[i]}</option>`;
      }
      for (let y = 1990; y <= 2100; y++) {
        yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
      }
      monthSelect.value = selectedMonth;
      yearSelect.value = selectedYear;

      monthSelect.addEventListener("change", () => {
        selectedMonth = parseInt(monthSelect.value);
        generateCalendar();
      });
      yearSelect.addEventListener("change", () => {
        selectedYear = parseInt(yearSelect.value);
        generateCalendar();
      });

      function generateCalendar() {
        const firstDay = new Date(selectedYear, selectedMonth, 1).getDay();
        const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
        calendarEl.innerHTML = "";

        for (let i = 0; i < firstDay; i++) {
          calendarEl.innerHTML += `<div></div>`;
        }

        for (let d = 1; d <= daysInMonth; d++) {
          const dateStr = `${selectedYear}-${String(selectedMonth + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
          calendarEl.innerHTML += `<div class="day" onclick="openForm('${dateStr}')">${d}</div>`;
        }
      }

      function formatDate(dateStr) {
        const date = new Date(dateStr);
        return `${monthNames[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
      }

      function openForm(date) {
        selectedDate = date;
        document.getElementById("desc").value = "";
        document.getElementById("amount").value = "";
        document.getElementById("type").value = "in";

        selectedDateTitle.textContent = `Entries for ${formatDate(date)}`;
        document.getElementById("entryModal").style.display = "block";
        document.getElementById("modalOverlay").style.display = "block";
        showEntries();
      }

      function closeModal() {
        document.getElementById("entryModal").style.display = "none";
        document.getElementById("modalOverlay").style.display = "none";
      }

      function addEntry() {
        const desc = document.getElementById("desc").value;
        const amount = parseFloat(document.getElementById("amount").value);
        const type = document.getElementById("type").value;
        if (!desc || isNaN(amount)) return;

        if (!financeData[selectedDate]) financeData[selectedDate] = [];
        financeData[selectedDate].push({ desc, amount, type });
        localStorage.setItem("financeData", JSON.stringify(financeData));
        showToast("Entry added!");
        showEntries();

        document.getElementById("desc").value = "";
        document.getElementById("amount").value = "";
        document.getElementById("type").value = "in";
      }

      function deleteEntry(index) {
        financeData[selectedDate].splice(index, 1);
        localStorage.setItem("financeData", JSON.stringify(financeData));
        showEntries();
      }

      function showEntries() {
        const entries = financeData[selectedDate] || [];
        let total = 0;

        entryList.innerHTML = entries.map((e, i) => {
          const color = e.type === "out" ? "red" : "green";
          const signedAmount = e.type === "out" ? -e.amount : e.amount;
          total += signedAmount;

          return `<li style="color:${color}">${e.desc} (${e.type === "in" ? "IN" : "OUT"}) - ₱${e.amount}
            <button onclick="deleteEntry(${i})">Delete</button></li>`;
        }).join("");

        entryList.innerHTML += `<li style="margin-top:10px; font-weight:bold;">Total: ₱${total.toFixed(2)}</li>`;
      }

      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = "show";
        setTimeout(() => {
          toast.className = toast.className.replace("show", "");
        }, 2000);
      }

      generateCalendar();
    </script>
  </body>
</html>
